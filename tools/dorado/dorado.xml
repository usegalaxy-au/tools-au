<tool id="dorado" name="Dorado" description="basecaller for raw Oxford Nanopore data" version="@VERSION@+galaxy0" python_template_version="3.5" profile="21.05">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[

ln -s '$pod5_file' ./reads.pod5 &&

dorado basecaller
--trim '${trim}'
'${model.fields.path}'
reads.pod5 
> calls.bam

&& 

dorado summary
calls.bam 
> summary.tsv

    ]]></command>
    <inputs>
        <param name="pod5_file" type="data" format="fast5" label="Raw fast5 file"/>
        <param name="model" type="select" label="Basecalling model. See the Help section for info on model names." >
            <options from_data_table="dorado_models">
                <!-- only allow models that shipped in this container -->
                <filter type="static_value" column="1" value="@CONTAINER_HASH@"/>
            </options>
        </param>
        <param type="select" argument="--trim" label="DNA adapter and primer trimming" help="Detect and remove any adapter and/or primer sequences from the beginning and end of DNA reads. Note that if you intend to demultiplex the reads, trimming adapters and primers could interfere with correct demultiplexing.">
            <option value="all" selected="true">Any. Trim any detected adapters or primers.</option>
            <option value="primers"> Primers. Trim any detected adapters or primers, but if barcoding is enabled the barcode sequences will not be trimmed.</option>
            <option value="adapters"> Adapters. Trim any detected adapters, but primers will not be trimmed, and if barcoding is enabled then barcodes will not be trimmed either.</option>
            <option value="none"> None. Nothing will be trimmed.</option>
        </param>
    </inputs>
    <outputs>
        <data format="unsorted.bam" name="out_bam" label="Basecalled reads" from_work_dir="calls.bam"/>
        <data format="tsv" name="out_tsv" label="Sequencing summary file" from_work_dir="summary.tsv"/>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="pod5_file" value="FAL00375_473bf0ed_0.ten_reads.pod5"/>
            <param name="model" value="dna_r9.4.1_e8_fast@v3.4"/>
            <param name="trim" value="all"/>
            <output name="out_bam">
                <assert_contents>
                    <has_size value="60692" delta="6000"/>
                </assert_contents>
            </output>
            <output name="out_tsv">
                <assert_contents>
                    <has_size value="1651" delta="200"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="2">
            <param name="pod5_file" value="FAL00375_473bf0ed_0.ten_reads.pod5"/>
            <param name="model" value="dna_r9.4.1_e8_fast@v3.4"/>
            <param name="trim" value="adapters"/>
            <output name="out_bam">
                <assert_contents>
                    <has_size value="60692" delta="6000"/>
                </assert_contents>
            </output>
            <output name="out_tsv">
                <assert_contents>
                    <has_size value="1651" delta="200"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
Basecall raw Nanopore data using Oxford Nanopore’s open source
`dorado <https://github.com/nanoporetech/dorado/>`__ basecaller.

The input is ``pod5`` format. If you have older data in fast5 format,
you can convert them using the pod5 convert tool.

Basecalling models
------------------

**TLDR: to decide which model to use, see Oxford Nanopore’s** `table of
basecalling
models <https://github.com/nanoporetech/dorado/?tab=readme-ov-file#decoding-dorado-model-names>`__.

The names of Dorado models are structured with each segment
corresponding to a different aspect of the model separated by
underscores.

For example, the model ``dna_r10.4.1_e8.2_400bps_hac@v4.3.0`` can be
decoded as follows:

Analyte Type (``dna``):
   -  For DNA sequencing, it is represented as dna. If you are using a
      Direct RNA Sequencing Kit, this will be rna002 or rna004,
      depending on the kit.
Pore Type (``r10.4.1``):
   -  The type of flow cell used.
Chemistry Type (``e8.2``):
   -  The chemistry type, which corresponds to the kit used for
      sequencing. For example, Kit 14 chemistry is denoted by e8.2 and
      Kit 10 or Kit 9 are denoted by e8.
Translocation Speed (``400bps``):
   -  The speed of translocation selected at the run setup in MinKNOW
Model Type (``hac``):
   -  The size of the model, where larger models yield more accurate
      basecalls but take more time. The three types of models are fast,
      hac, and sup. The fast model is the quickest, sup is the most
      accurate, and hac provides a balance between speed and accuracy.
Model Version Number (``v4.3.0``):
   -  The version of the model. Model updates are regularly released,
      and higher version numbers typically signify greater accuracy.

    ]]></help>
</tool>
